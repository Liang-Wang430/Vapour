 import numpy as np
import pandas as pd
import xlsxwriter
import glob, os
import matplotlib.pyplot as plt

workbook = xlsxwriter.Workbook('new_excel.xlsx')      #新建excel表
worksheet1 = workbook.add_worksheet()                  #新建sheet1
worksheet2 = workbook.add_worksheet()                  #新建sheet2
headings = ['风速','叶片1扭矩','叶片2扭矩','叶片3扭矩','轴1变桨速度','轴2变桨速度','轴3变桨速度','叶片1电机电流','叶片2电机电流','叶片3电机电流','叶片1电机温度','叶片2电机温度','叶片3电机温度',"启机时间"]     #设置sheet表头
worksheet1.write_row('A1',headings)
worksheet2.write_row('A1',headings)
data1 = pd.read_csv('10-20190501-20190510_US.csv')    #将第1个excel表格数据放入data1中，excel表格必须放在分析文件夹里面
data2 = pd.read_csv('10-20190511-20190525_US.csv')    #将第2个excel表格数据放入data2中，excel表格必须放在分析文件夹里面

def data_processing(data):             #定义一个方法def ,方法名称是data_processing，该方法是寻找变桨过程的起始行和终止行
    a_list = []                        #定义一个矩阵，用来存放单次变桨过程的起始行数i和终止行数j [i,j,i,j...]
    for i in range(len(data['叶片1桨距角'])):
        if data.loc[i, '叶片1桨距角'] == 90 and data.loc[i + 1, '叶片1桨距角'] < 90 and data.loc[i+30,'叶片1桨距角']<90:
            print('起点', i)
            for j in range(i + 1, len(data['叶片1桨距角'])):
                if data.loc[j, '叶片1桨距角'] >= 1.5 and data.loc[j + 1, '叶片1桨距角'] < 1.5:
                    print('终点', j)
                    a_list.append(i)    # 将起始行数i放入矩阵a_list []
                    a_list.append(j)    # 将终止行数j放入矩阵a_list []
                    i=j                 #将j赋予i，第二个循环的起点从第一个循环终点开始，减少运算时间
                    break
                elif j - i >= 200:      #仅仅挑选变桨过程<200秒的
                    break
    print(a_list)                       #显示矩阵 a_list []

    return a_list                       #返回矩阵 a_list []，这一步非常重要，返回的 a_list []为后续画图步骤做准备

def data_write1(list, data):             #定义一个方法def,方法名称是data_write，该方法是用来向excel里面写入数据
    for i in range(0, len(list), 2):    # 2是步长
        data_result = data.loc[list[i]:list[i + 1], :]
        data_result.to_csv('%s_result%d.csv' % ("data", (i + 2) / 2), encoding='utf_8_sig')
        x = np.mean(data_result['风速'])          #mean代表求均值
        y1 = np.mean(data_result['叶片1扭矩'])
        y2 = np.mean(data_result['叶片2扭矩'])
        y3 = np.mean(data_result['叶片3扭矩'])
        y4 = np.mean(data_result['轴1变桨速度'])
        y5 = np.mean(data_result['轴2变桨速度'])
        y6 = np.mean(data_result['轴3变桨速度'])
        y7 = np.mean(data_result['叶片1电机电流'])
        y8 = np.mean(data_result['叶片2电机电流'])
        y9 = np.mean(data_result['叶片3电机电流'])
        y10 = np.mean(data_result['叶片1电机温度'])
        y11 = np.mean(data_result['叶片2电机温度'])
        y12 = np.mean(data_result['叶片3电机温度'])
        y13 = (list[i + 1]-list[i])/60        #叶片变桨电启机时间
        worksheet1.write(i+1, 0, x)    #第1列是中文表头，所以是i+1
        worksheet1.write(i+1, 1, y1)
        worksheet1.write(i+1, 2, y2)
        worksheet1.write(i+1, 3, y3)
        worksheet1.write(i+1, 4, y4)
        worksheet1.write(i+1, 5, y5)
        worksheet1.write(i+1, 6, y6)
        worksheet1.write(i+1, 7, y7)
        worksheet1.write(i+1, 8, y8)
        worksheet1.write(i+1, 9, y9)
        worksheet1.write(i+1, 10, y10)
        worksheet1.write(i+1, 11, y11)
        worksheet1.write(i+1, 12, y12)
        worksheet1.write(i+1, 13, y13)
def data_write2(list, data):             #定义一个方法def,方法名称是data_write，该方法是用来向excel里面写入数据
    for i in range(0, len(list), 2):    # 2是步长
        data_result = data.loc[list[i]:list[i + 1], :]
        data_result.to_csv('%s_result%d.csv' % ("data", (i + 2) / 2), encoding='utf_8_sig')
        x = np.mean(data_result['风速'])          #mean代表求均值
        y1 = np.mean(data_result['叶片1扭矩'])
        y2 = np.mean(data_result['叶片2扭矩'])
        y3 = np.mean(data_result['叶片3扭矩'])
        y4 = np.mean(data_result['轴1变桨速度'])
        y5 = np.mean(data_result['轴2变桨速度'])
        y6 = np.mean(data_result['轴3变桨速度'])
        y7 = np.mean(data_result['叶片1电机电流'])
        y8 = np.mean(data_result['叶片2电机电流'])
        y9 = np.mean(data_result['叶片3电机电流'])
        y10 = np.mean(data_result['叶片1电机温度'])
        y11 = np.mean(data_result['叶片2电机温度'])
        y12 = np.mean(data_result['叶片3电机温度'])
        y13 = (list[i + 1] - list[i]) / 60  # 叶片变桨电启机时间
        worksheet2.write(i+1, 0, x)
        worksheet2.write(i+1, 1, y1)
        worksheet2.write(i+1, 2, y2)
        worksheet2.write(i+1, 3, y3)
        worksheet2.write(i+1, 4, y4)
        worksheet2.write(i+1, 5, y5)
        worksheet2.write(i+1, 6, y6)
        worksheet2.write(i+1, 7, y7)
        worksheet2.write(i+1, 8, y8)
        worksheet2.write(i+1, 9, y9)
        worksheet2.write(i+1, 10, y10)
        worksheet2.write(i+1, 11, y11)
        worksheet2.write(i+1, 12, y12)
        worksheet2.write(i+1, 13, y13)
data1_result_list = data_processing(data1)   #对第1个excel表格（data1）使用方法data_processing，返回第1个excel表格里面变桨过程的起始和终止行数
data2_result_list = data_processing(data2)   #对第2个excel表格(data2)使用方法data_processing，返回第2个excel表格里面变桨过程的起始和终止行数

data_write1(data1_result_list,data1)          #对第1个excel表格里面变桨过程涉及到的行数，使用方法data_write1
data_write2(data2_result_list,data2)          #对第2个excel表格里面变桨过程涉及到的行数，使用方法data_write2

workbook.close()                              #关闭excel，这一步必不可少

